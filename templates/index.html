<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>淘宝Deeplink提取服务</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #d9534f; } /* 主题色 */
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="file"], select {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px;
        }
        button {
            background-color: #d9534f; color: white; padding: 10px 15px; border: none;
            border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px;
        }
        button:hover { background-color: #c9302c; }
        .section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .section:last-child { border-bottom: none; }

        /* 加载弹窗样式 */
        .loading-modal {
            display: none; /* 默认隐藏 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #d9534f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 添加模态框样式 */
        .modal {
            display: none; /* 默认隐藏 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);

            /* 修复模态框内容超出边界的问题 */
            max-height: 80vh; /* 限制模态框内容的最大高度 */
            overflow-y: auto; /* 启用垂直滚动条 */
            word-wrap: break-word; /* 自动换行，避免内容超出边界 */
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 创建加载弹窗
            const loadingModal = document.createElement('div');
            loadingModal.className = 'loading-modal';
            loadingModal.innerHTML = '<div class="loading-spinner"></div>';
            document.body.appendChild(loadingModal);

            // 显示加载弹窗
            function showLoading() {
                loadingModal.style.display = 'flex';
            }

            // 隐藏加载弹窗
            function hideLoading() {
                loadingModal.style.display = 'none';
            }

            // 页面加载完成时隐藏加载弹窗
            hideLoading();

            // 单个链接提取逻辑
            const singleLinkForm = document.getElementById('single-link-form');
            //const platformSelect = document.getElementById('platform');

            if (singleLinkForm) {
                singleLinkForm.addEventListener('submit', function(event) {
                    event.preventDefault(); // 阻止默认表单提交
                    showLoading();

                    const formData = new FormData(this);
                    //formData.append('platform', platformSelect.value); // 添加 platform 参数

                    const action = this.getAttribute('action');

                    fetch(action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('网络响应失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const modal = document.getElementById('result-modal');
                        const modalContent = document.getElementById('modal-content');

                        modalContent.innerHTML = '<span class="close">&times;</span>';
                        if (data.error) {
                            modalContent.innerHTML += `<p style='color: red;'>错误: ${data.error}</p>`;
                        } else {
                            modalContent.innerHTML += '<h3>提取结果</h3>';
                            data.results.forEach(result => {
                                modalContent.innerHTML += `
                                <div style="padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9;">
                                    <p><strong>原始链接:</strong> <a href="${result['原始链接']}" target="_blank" style="color: #007bff;">${result['原始链接']}</a></p>
                                    <p><strong>Deeplink:</strong> <a href="${result['Deeplink']}" target="_blank" style="color: #28a745;">${result['Deeplink']}</a></p>
                                    <p><strong>h5Dp:</strong> <a href="${result['h5Dp']}" target="_blank" style="color: #28a745;">${result['h5Dp']}</a></p>
                                    <p><strong>状态:</strong> <span style="color: ${result['状态'] === '成功' ? 'green' : 'red'};">${result['状态']}</span></p>
                                </div>
                                `;
                            });
                        }

                        const closeModal = modalContent.querySelector('.close');
                        closeModal.onclick = function() {
                            modal.style.display = 'none';
                        };

                        modal.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('处理失败:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
                });
            }

            // 批量链接提取逻辑
            //const uploadForm = document.querySelector('form[action="/ulink{{ url_for('upload_and_extract_file') }}"]');
            const uploadForm = document.getElementById('upload-link-form');

            function getBatchStatsFromCookie() {
                const match = document.cookie.match(/batch_stats=([^;]+)/);
                if (match) {
                    // 去掉首尾引号
                    let raw = match[1];
                    if (raw.startsWith('"') && raw.endsWith('"')) {
                        raw = raw.slice(1, -1);
                    }
                    // 处理 \\073 为分号
                    raw = decodeURIComponent(raw.replace(/\\073/g, ';'));
                    const stats = raw.split(';').reduce((acc, pair) => {
                        const [k, v] = pair.split('=');
                        acc[k.trim()] = v.trim();
                        return acc;
                    }, {});
                    return stats;
                }
                return null;
            }

            if (uploadForm) {
                uploadForm.addEventListener('submit', function(event) {
                    event.preventDefault(); // 阻止默认表单提交
                    showLoading();

                    const formData = new FormData(this);
                    //const platformSelect = document.getElementById('platform');
                    //formData.append('platform', platformSelect.value); // 添加 platform 参数

                    const action = this.getAttribute('action');

                    fetch(action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            // 处理后端返回的错误信息
                            return response.text().then(text => {
                                //alert(text); // 直接弹窗提示后端返回的错误信息
                                throw new Error(text); // 阻止后续 then 执行
                            });
                        }
                        return response.blob(); // 处理文件下载
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'deeplink_results.xlsx'; // 设置下载文件名
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);

                        // 下载完成后读取 cookie 并弹窗提示
                        setTimeout(() => {
                            const stats = getBatchStatsFromCookie();
                            if (stats) {
                                alert(`批量转链完成！成功：${stats.success} 条，失败：${stats.fail} 条。`);
                            }
                        }, 500);
                    })
                    .catch(error => {
                        // 这里弹窗展示后端返回的错误信息
                        alert(error.message);
                    })
                    .finally(() => {
                        hideLoading();
                    });
                });
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>淘宝Deeplink提取服务</h1>

        <!-- 添加安卓和 iOS 的选择框 -->
        <!-- <label for="platform">选择平台:</label>
        <select id="platform" name="platform" required>
            <option value="ios">iOS</option>
            <option value="android">安卓</option>
        </select> -->

        <div class="section">
            <h2>单个链接提取</h2>
            <form id="single-link-form" action="/ulink{{ url_for('extract_single_link') }}" method="post">
                <label for="short_url">输入淘宝短链接:</label>
                <input type="text" id="short_url" name="short_url" required>
                <button type="submit">提取Deeplink <span class="spinner"></span></button>
            </form>
        </div>

        <div class="section">
            <h2>批量链接提取 (通过文件上传)</h2>
            <p>请上传一个文本文件 (.txt)，每行包含一个淘宝短链接。</p>
            <form id="upload-link-form" action="/ulink{{ url_for('upload_and_extract_file') }}" method="post" enctype="multipart/form-data">
                <label for="link_file">选择文件:</label>
                <input type="file" id="link_file" name="link_file" accept=".txt" required>
                <button type="submit">上传并提取 <span class="spinner"></span></button>
            </form>
        </div>
        
        <!-- 添加模态框结构 -->
        <div id="result-modal" class="modal">
            <div id="modal-content" class="modal-content">
                <span class="close">&times;</span>
            </div>
        </div>
    </div>
</body>
</html>
