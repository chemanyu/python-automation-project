<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>淘宝Deeplink提取服务</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #d9534f; } /* 主题色 */
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="file"] {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px;
        }
        button {
            background-color: #d9534f; color: white; padding: 10px 15px; border: none;
            border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px;
        }
        button:hover { background-color: #c9302c; }
        .section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .section:last-child { border-bottom: none; }

        /* 加载弹窗样式 */
        .loading-modal {
            display: none; /* 默认隐藏 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #d9534f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 添加模态框样式 */
        .modal {
            display: none; /* 默认隐藏 */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);

            /* 修复模态框内容超出边界的问题 */
            max-height: 80vh; /* 限制模态框内容的最大高度 */
            overflow-y: auto; /* 启用垂直滚动条 */
            word-wrap: break-word; /* 自动换行，避免内容超出边界 */
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 创建加载弹窗
            const loadingModal = document.createElement('div');
            loadingModal.className = 'loading-modal';
            loadingModal.innerHTML = '<div class="loading-spinner"></div>';
            document.body.appendChild(loadingModal);

            // 显示加载弹窗
            function showLoading() {
                loadingModal.style.display = 'flex';
            }

            // 隐藏加载弹窗
            function hideLoading() {
                loadingModal.style.display = 'none';
            }

            // 页面加载完成时隐藏加载弹窗
            hideLoading();

            // 单个链接提取逻辑
            const singleLinkForm = document.querySelector('form[action="{{ url_for('extract_single_link') }}"]');
            if (singleLinkForm) {
                singleLinkForm.addEventListener('submit', function(event) {
                    event.preventDefault(); // 阻止默认表单提交
                    showLoading();

                    const formData = new FormData(this);
                    const action = this.getAttribute('action');

                    fetch(action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('网络响应失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const modal = document.getElementById('result-modal');
                        const modalContent = document.getElementById('modal-content');

                        modalContent.innerHTML = '<span class="close">&times;</span>';
                        if (data.error) {
                            modalContent.innerHTML += `<p style='color: red;'>错误: ${data.error}</p>`;
                        } else {
                            modalContent.innerHTML += '<h3>提取结果</h3>';
                            data.results.forEach(result => {
                                modalContent.innerHTML += `<p>原始链接: ${result['原始链接']}<br>Deeplink: ${result['Deeplink']}<br>状态: ${result['状态']}</p>`;
                            });
                        }

                        const closeModal = modalContent.querySelector('.close');
                        closeModal.onclick = function() {
                            modal.style.display = 'none';
                        };

                        modal.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('处理失败:', error);
                    })
                    .finally(() => {
                        hideLoading();
                    });
                });
            }

            // 批量链接提取逻辑
            const uploadForm = document.querySelector('form[action="{{ url_for('upload_and_extract_file') }}"]');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(event) {
                    showLoading(); // 显示加载动画

                    // 设置表单的 target 为 iframe
                    this.target = 'upload_iframe';

                    // 创建隐藏的 iframe 用于监听下载完成
                    let iframe = document.getElementById('upload_iframe');
                    if (!iframe) {
                        iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.id = 'upload_iframe';
                        iframe.name = 'upload_iframe';
                        document.body.appendChild(iframe);
                    }

                    // 开始轮询检测 Cookie
                    function waitForDownload() {
                        const interval = setInterval(() => {
                            if (document.cookie.includes("download_done=true")) {
                                clearInterval(interval);
                                hideLoading(); // 隐藏加载动画

                                // 清除 cookie
                                document.cookie = "download_done=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

                                // 重置表单
                                uploadForm.reset();
                            }
                        }, 500); // 每 0.5 秒检测一次
                    }

                    waitForDownload();
                });
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>淘宝Deeplink提取服务</h1>

        <div class="section">
            <h2>单个链接提取</h2>
            <form action="{{ url_for('extract_single_link') }}" method="post">
                <label for="short_url">输入淘宝短链接:</label>
                <input type="text" id="short_url" name="short_url" required>
                <button type="submit">提取Deeplink <span class="spinner"></span></button>
            </form>
        </div>

        <div class="section">
            <h2>批量链接提取 (通过文件上传)</h2>
            <p>请上传一个文本文件 (.txt)，每行包含一个淘宝短链接。</p>
            <form action="{{ url_for('upload_and_extract_file') }}" method="post" enctype="multipart/form-data">
                <label for="link_file">选择文件:</label>
                <input type="file" id="link_file" name="link_file" accept=".txt" required>
                <button type="submit">上传并提取 <span class="spinner"></span></button>
            </form>
        </div>

        <!-- 添加模态框结构 -->
        <div id="result-modal" class="modal">
            <div id="modal-content" class="modal-content">
                <span class="close">&times;</span>
            </div>
        </div>
    </div>
</body>
</html>
